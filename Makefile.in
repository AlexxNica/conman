##
# ConMan Makefile
#   by Chris Dunlap <cdunlap@llnl.gov>
##
# $Id: Makefile.in,v 1.56 2003/08/02 00:02:18 dun Exp $
##

PROJECT=	conman

SHELL=		@SHELL@
CC=		@CC@
DEFS=		@DEFS@
CFLAGS=		@CFLAGS@
LDFLAGS=	@LDFLAGS@
LIBS=		@LIBS@
RANLIB=		@RANLIB@
INSTALL=	@INSTALL@
@SET_MAKE@
COPTS=		$(CFLAGS) $(CPPFLAGS) $(DEFS)

top_srcdir=	@top_srcdir@
prefix=		@prefix@
exec_prefix=	@exec_prefix@
bindir=		@bindir@
sbindir=	@sbindir@
libdir=		@libdir@
mandir=		@mandir@

AC_OUTPUT=	Makefile config.h conman.spec \
		man/conman.1 man/conman.conf.5 man/conmand.8

CONF=		@CONMAN_CONF@
PROGS=		conman conmand
COMMON_OBJS1=	common.o fd.o list.o lex.o log.o str.o tty.o
COMMON_OBJS2=	util.o util-net.o
COMMON_OBJS=	$(COMMON_OBJS1) $(COMMON_OBJS2) @LIBOBJS@
CLIENT_OBJS1=	client.o client-conf.o client-sock.o client-tty.o
CLIENT_OBJS=	$(CLIENT_OBJS1) $(COMMON_OBJS)
SERVER_OBJS1=	server.o server-conf.o server-esc.o server-logfile.o
SERVER_OBJS2=	server-obj.o server-serial.o server-sock.o tselect.o
SERVER_OBJS=	$(SERVER_OBJS1) $(SERVER_OBJS2) $(COMMON_OBJS)
COMMON_LIBS=	-lpthread $(LIBS)
CLIENT_LIBS=	$(COMMON_LIBS)
SERVER_LIBS=	$(COMMON_LIBS)


all: $(PROGS) tags

conman: $(CLIENT_OBJS)
	$(CC) $(COPTS) $(LDFLAGS) $(CLIENT_OBJS) -o $@ $(CLIENT_LIBS)

conmand: $(SERVER_OBJS)
	$(CC) $(COPTS) $(LDFLAGS) $(SERVER_OBJS) -o $@ $(SERVER_LIBS)

.c.o:
	$(CC) $(COPTS) -c $<

install: $(PROGS)
	$(INSTALL) -m 755 -d $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 -s conman $(DESTDIR)$(bindir)/
	$(INSTALL) -m 755 conmen $(DESTDIR)$(bindir)/
	$(INSTALL) -m 755 -d $(DESTDIR)$(sbindir)
	$(INSTALL) -m 755 -s conmand $(DESTDIR)$(sbindir)/
	@if test ! -f $(DESTDIR)$(CONF); then \
	  echo $(INSTALL) -m 755 -d $(DESTDIR)/etc; \
	  $(INSTALL) -m 755 -d $(DESTDIR)/etc; \
	  echo $(INSTALL) -m 644 etc/conman.conf $(DESTDIR)$(CONF); \
	  $(INSTALL) -m 644 etc/conman.conf $(DESTDIR)$(CONF); \
	fi
	@for d in /etc/logrotate.d; do \
	  if test -d "$$d"; then \
	    if test ! -f $(DESTDIR)$$d/conman; then \
	      echo $(INSTALL) -m 755 -d $(DESTDIR)$$d; \
	      $(INSTALL) -m 755 -d $(DESTDIR)$$d; \
	      echo $(INSTALL) -m 644 etc/conman.logrotate $(DESTDIR)$$d/conman; \
	      $(INSTALL) -m 644 etc/conman.logrotate $(DESTDIR)$$d/conman; \
	    fi; \
	    break; \
	  fi; \
	done
	@for d in /etc/rc.d/init.d /etc/init.d /sbin/init.d; do \
	  if test -d "$$d"; then \
	    echo $(INSTALL) -m 755 -d $(DESTDIR)$$d; \
	    $(INSTALL) -m 755 -d $(DESTDIR)$$d; \
	    echo $(INSTALL) -m 755 etc/conman.init $(DESTDIR)$$d/conman; \
	    $(INSTALL) -m 755 etc/conman.init $(DESTDIR)$$d/conman; \
	    break; \
	  fi; \
	done
	@for f in `cd lib >/dev/null && find * -name CVS -prune -o -type f -print`; do \
	  echo $(INSTALL) -m 755 -d `dirname $(DESTDIR)$(libdir)/$(PROJECT)/$$f`; \
	  $(INSTALL) -m 755 -d `dirname $(DESTDIR)$(libdir)/$(PROJECT)/$$f`; \
	  echo $(INSTALL) -m 755 lib/$$f $(DESTDIR)$(libdir)/$(PROJECT)/$$f; \
	  $(INSTALL) -m 755 lib/$$f $(DESTDIR)$(libdir)/$(PROJECT)/$$f; \
	done
	chmod 644 $(DESTDIR)$(libdir)/$(PROJECT)/*.exp
	@for d in man1 man5 man8; do \
	  echo $(INSTALL) -m 755 -d $(DESTDIR)$(mandir)/$$d; \
	  $(INSTALL) -m 755 -d $(DESTDIR)$(mandir)/$$d; \
	done
	$(INSTALL) -m 644 man/conman.1 \
	  $(DESTDIR)$(mandir)/man1/conman.1
	$(INSTALL) -m 644 man/conman.conf.5 \
	  $(DESTDIR)$(mandir)/man5/conman.conf.5
	$(INSTALL) -m 644 man/conmand.8 \
	  $(DESTDIR)$(mandir)/man8/conmand.8

clean:
	-rm -f *.o *.a *~ \#* .\#* cscope*.out core core.* *.core tags TAGS

realclean: clean
	-rm -f $(PROGS)
	-rm -f *.tgz* *.rpm

distclean: realclean
	-rm -f config.cache config.log config.status stamp-h Makefile.bak
	-rm -f $(AC_OUTPUT)
	-rm -rf autom4te*.cache

depend:
	-makedepend -Y -- $(COPTS) -- *.[ch] 2>/dev/null

tags: *.[ch]
	-ctags *.[ch] 2>/dev/null

include Make-rpm.mk


# AUTO-REMAKE OF AUTOCONF-RELATED TARGETS

Makefile: Makefile.in config.status
	./config.status

config.status: META
	./config.status --recheck

$(PROJECT).spec: $(PROJECT).spec.in
	./config.status $@


# DO NOT DELETE THIS LINE -- make depend depends on it.
