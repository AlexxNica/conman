##
# ConMan Makefile
#   by Chris Dunlap <cdunlap@llnl.gov>
#
# $Id: Makefile.in,v 1.26 2001/09/25 20:48:51 dun Exp $
##

PACKAGE=	@PACKAGE@
VERSION=	@VERSION@

SHELL=		@SHELL@
CC=		@CC@
DEFS=		@DEFS@
CFLAGS=		@CFLAGS@
LDFLAGS=	@LDFLAGS@
LIBS=		@LIBS@
RANLIB=		@RANLIB@
INSTALL=	@INSTALL@
mkinstalldirs=	$(SHELL) $(top_srcdir)/auxdir/mkinstalldirs
@SET_MAKE@
COPTS=		$(CFLAGS) $(CPPFLAGS) $(DEFS)

AC_OUTPUT=	Makefile config.h conman.spec

top_srcdir=	@top_srcdir@
prefix=		@prefix@
exec_prefix=	@exec_prefix@
bindir=		@bindir@
sbindir=	@sbindir@
libdir=		@libdir@

PROGS=		conman conmand
COMMON_OBJS1=	common.o errors.o list.o lex.o
COMMON_OBJS2=	util.o util-file.o util-net.o util-str.o
COMMON_OBJS=	$(COMMON_OBJS1) $(COMMON_OBJS2) @LIBOBJS@
CLIENT_OBJS=	client.o client-conf.o client-sock.o client-tty.o $(COMMON_OBJS)
SERVER_OBJS1=	server.o server-conf.o server-esc.o server-obj.o server-sock.o
SERVER_OBJS2=	server-tty.o tselect.o
SERVER_OBJS=	$(SERVER_OBJS1) $(SERVER_OBJS2) $(COMMON_OBJS)
COMMON_LIBS=	$(LIBS)
CLIENT_LIBS=	$(COMMON_LIBS)
SERVER_LIBS=	-lpthread $(COMMON_LIBS)


all: $(PROGS)

conman: $(CLIENT_OBJS)
	$(CC) $(COPTS) $(LDFLAGS) $(CLIENT_OBJS) -o $@ $(CLIENT_LIBS)

conmand: $(SERVER_OBJS)
	$(CC) $(COPTS) $(LDFLAGS) $(SERVER_OBJS) -o $@ $(SERVER_LIBS)

.c.o:
	$(CC) $(COPTS) -c $<

depend:
	makedepend -Y -- $(COPTS) -- *.[ch] 2>/dev/null

install: $(PROGS)
	$(mkinstalldirs) $(DESTDIR)$(bindir)
	$(INSTALL) conman $(DESTDIR)$(bindir)/
	$(INSTALL) conmen $(DESTDIR)$(bindir)/
	$(mkinstalldirs) $(DESTDIR)$(sbindir)
	$(INSTALL) conmand $(DESTDIR)$(sbindir)/
	$(mkinstalldirs) $(DESTDIR)/etc
	$(INSTALL) -m 644 etc/conman.conf $(DESTDIR)/etc
	$(mkinstalldirs) $(DESTDIR)/etc/rc.d/init.d
	$(INSTALL) -m 755 etc/conman.init $(DESTDIR)/etc/rc.d/init.d/conman
	for f in `cd lib && find * -name "CVS" -prune -o -type f -print`; do \
	  $(mkinstalldirs) `dirname $(DESTDIR)$(libdir)/$(PACKAGE)/$$f`; \
	  $(INSTALL) -m 755 lib/$$f $(DESTDIR)$(libdir)/$(PACKAGE)/$$f; \
	done
	chmod 644 $(DESTDIR)$(libdir)/$(PACKAGE)/*.exp

clean:
	-rm -f *.o *.a *~ \#* core *.core cscope*.out

realclean: clean
	-rm -f $(PROGS)
	-rm -f *.tgz *.rpm

distclean: realclean
	-rm -f config.cache config.log config.status stamp-h Makefile.bak
	-rm -f $(AC_OUTPUT)


# AUTO-REMAKE OF AUTOCONF-RELATED TARGETS

Makefile: Makefile.in config.status
	./config.status

config.status: VERSION
	./config.status --recheck

$(PACKAGE).spec: $(PACKAGE).spec.in
	./config.status $@


# DEVELOPER TARGETS

rpm tar:
	@if test -z "$(PACKAGE)"; then \
	  echo "ERROR: Undefined PACKAGE macro definition" 1>&2; exit 0; fi; \
	if test -z "$(VERSION)"; then \
	  echo "ERROR: Undefined VERSION macro definition" 1>&2; exit 0; fi; \
	test -z "$$tag" && tag=`echo $(PACKAGE)-$(VERSION) | tr '.' '-'`; \
	ver=`cvs -Q co -r $$tag -p $(PACKAGE)/VERSION | \
	  sed -ne 's/.*-\(.*\)/\1/p'`; \
	test -z "$$rel" && rel=1; \
	if test -z "$$ver"; then \
	  echo "ERROR: Cannot determine VERSION (tag=$$tag)" 1>&2; exit 0; fi; \
	$(MAKE) -s $@-internal tag=$$tag ver=$$ver rel=$$rel

rpm-internal: tar-internal
	@test -z "$$tag" -o -z "$$ver" && exit 1; \
	tmp=$${TMPDIR-/tmp}/tmp-$(PACKAGE)-$$$$; \
	tar=$(PACKAGE)-$$ver.tgz; \
	for d in BUILD RPMS SOURCES SPECS SRPMS TMP; do \
	  $(mkinstalldirs) $$tmp/$$d >/dev/null; \
	done; \
	cp -p $$tar $$tmp/SOURCES; \
	(cvs -Q co -r $$tag -p $(PACKAGE)/$(PACKAGE).spec.in || \
	  cvs -Q co -r $$tag -p $(PACKAGE)/$(PACKAGE).spec) | \
	  sed -e "s/^\(%define name\).*/\1    $(PACKAGE)/i" \
	    -e "s/^\(%define version\).*/\1 $$ver/i" \
	    -e "s/^\(%define release\).*/\1 $$rel/i" \
	    >$$tmp/SPECS/$(PACKAGE).spec; \
	if ! test -s $$tmp/SPECS/$(PACKAGE).spec; then \
	  echo "ERROR: No $(PACKAGE).spec file (tag=$$tag)" 1>&2; \
	  rm -rf $$tmp; exit 0; fi; \
	echo "creating $(PACKAGE)-$$ver*rpm (tag=$$tag)"; \
	rpm --showrc | egrep "_(gpg|pgp)_name" >/dev/null && sign="--sign"; \
	rpm -ba --define "_tmppath $$tmp/TMP" --define "_topdir $$tmp" \
	  $$sign --quiet $$tmp/SPECS/$(PACKAGE).spec >/dev/null 2>&1 && \
	    cp -p $$tmp/RPMS/*/$(PACKAGE)-$$ver*.*.rpm \
	      $$tmp/SRPMS/$(PACKAGE)-$$ver*.src.rpm $(top_srcdir)/; \
	rm -rf $$tmp

tar-internal:
	@test -z "$$tag" -o -z "$$ver" && exit 1; \
	tmp=$${TMPDIR-/tmp}/tmp-$(PACKAGE)-$$$$; \
	name=$(PACKAGE)-$$ver; \
	dir=$$tmp/$$name; \
	tar=$$name.tgz; \
	rm -f $$tar; \
	echo "creating $$tar (tag=$$tag)"; \
	$(mkinstalldirs) $$tmp >/dev/null; \
	(cd $$tmp; cvs -Q export -r $$tag -d $$name $(PACKAGE)) && \
	  (cd $$tmp; tar cf - $$name) | gzip -c9 > $(top_srcdir)/$$tar; \
	rm -rf $$tmp; \
	if ! test -f $$tar; then \
	  echo "ERROR: Unable to create $$tar." 1>&2; exit 1; fi; \


# DO NOT DELETE THIS LINE -- make depend depends on it.
